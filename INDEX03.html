<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor de Notas - ZIP e Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    input { margin: 10px 0; display: block; }
    h2 { color: #2c3e50; }
    #resultadoZip, #resultadoExcel { margin-top: 10px; font-weight: bold; background: #fff; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    ul { padding-left: 20px; }
    li { font-weight: normal; }
  </style>
</head>
<body>

  <h2>1Ô∏è‚É£ Contar Arquivos XML em um Arquivo ZIP</h2>
  <input type="file" id="zipInput" accept=".zip">
  <div id="resultadoZip"></div>

  <hr>

  <h2>2Ô∏è‚É£ Ler Informa√ß√µes do Excel (Notas a partir de I3, Valores em N3, Status em S3)</h2>
  <input type="file" id="excelInput" accept=".xlsx, .xls">
  <div id="resultadoExcel"></div>

  <script>
    // === ZIP - Contar arquivos XML ===
    document.getElementById('zipInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const resultadoDiv = document.getElementById('resultadoZip');

      if (!file) {
        resultadoDiv.textContent = "Nenhum arquivo selecionado.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        JSZip.loadAsync(e.target.result).then(function(zip) {
          let count = 0;
          zip.forEach(function (relativePath, zipEntry) {
            if (zipEntry.name.toLowerCase().endsWith(".xml")) {
              count++;
            }
          });
          resultadoDiv.textContent = `Total de arquivos XML no ZIP: ${count}`;
        }).catch(function(err) {
          resultadoDiv.textContent = "Erro ao ler o arquivo ZIP: " + err;
        });
      };
      reader.readAsArrayBuffer(file);
    });

    // === Excel - Ler dados das colunas I (nota), N (valor), S (status) ===
    document.getElementById('excelInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const resultadoDiv = document.getElementById('resultadoExcel');

      if (!file) {
        resultadoDiv.textContent = "Nenhum arquivo selecionado.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        let row = 3;
        let totalNotas = 0;
        let somaValores = 0;
        let canceladas = [];

        while (true) {
          const notaCell = sheet[`I${row}`];
          const valorCell = sheet[`N${row}`];
          const statusCell = sheet[`S${row}`];

          if (!notaCell || !notaCell.v) break;

          totalNotas++;

          // Somar valor
          const valor = parseFloat(valorCell?.v || 0);
          somaValores += isNaN(valor) ? 0 : valor;

          // Verificar cancelamento
          const status = statusCell?.v || "";
          if (status.includes("Cancelamento de NF-e homologado")) {
            canceladas.push(notaCell.v);
          }

          row++;
        }

        const homologadas = totalNotas - canceladas.length;
        const diferenca = homologadas - canceladas.length;

        let html = `<p>Total de notas encontradas (coluna I, a partir de I3): <strong>${totalNotas}</strong></p>`;
        html += `<p>üßæ Soma total dos valores (coluna N): <strong>R$ ${somaValores.toFixed(2).replace('.', ',')}</strong></p>`;
        html += `<p>‚ùå Notas canceladas (coluna S): <strong>${canceladas.length}</strong></p>`;
        html += `<p>‚úÖ Notas homologadas (n√£o canceladas): <strong>${homologadas}</strong></p>`;
        html += `<p>üìä Diferen√ßa (homologadas - canceladas): <strong>${diferenca}</strong></p>`;

        if (canceladas.length > 0) {
          html += `<ul>` + canceladas.map(n => `<li>Nota cancelada: ${n}</li>`).join('') + `</ul>`;
        }

        resultadoDiv.innerHTML = html;
      };

      reader.readAsArrayBuffer(file);
    });
  </script>

</body>
</html>
