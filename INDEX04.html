<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor de Notas - ZIP e Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      padding: 40px;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: 40px;
    }
    .section h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #34495e;
    }
    input[type="file"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      cursor: pointer;
      width: 100%;
    }
    .result {
      margin-top: 20px;
      padding: 20px;
      background: #ecf0f1;
      border-left: 6px solid #3498db;
      border-radius: 8px;
    }
    .result p {
      margin: 8px 0;
      font-size: 16px;
    }
    .highlight {
      font-weight: bold;
      color: #2c3e50;
    }
    .canceladas {
      color: #e74c3c;
    }
    .homologadas {
      color: #27ae60;
    }
    ul {
      margin-top: 10px;
      padding-left: 20px;
    }
    li {
      font-weight: normal;
      font-size: 14px;
    }
    .footer {
      text-align: center;
      font-size: 14px;
      color: #999;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <h1>üìÑ Leitor de Notas Fiscais - ZIP e Excel</h1>
  <div class="container">
    
    <div class="section">
      <h2>üì¶ 1Ô∏è‚É£ Contar Arquivos XML em um Arquivo ZIP</h2>
      <input type="file" id="zipInput" accept=".zip">
      <div id="resultadoZip" class="result"></div>
    </div>

    <div class="section">
      <h2>üìä 2Ô∏è‚É£ Ler Informa√ß√µes do Excel</h2>
      <p>üìå A leitura come√ßa a partir da c√©lula <strong>I3</strong> (notas), <strong>N3</strong> (valores) e <strong>S3</strong> (status)</p>
      <input type="file" id="excelInput" accept=".xlsx, .xls">
      <div id="resultadoExcel" class="result"></div>
    </div>

    <div class="footer">
      Desenvolvido com üíô para leitura de NF-e
    </div>

  </div>

  <script>
    // ZIP - contar arquivos XML
    document.getElementById('zipInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const resultadoDiv = document.getElementById('resultadoZip');

      if (!file) {
        resultadoDiv.textContent = "Nenhum arquivo selecionado.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        JSZip.loadAsync(e.target.result).then(function(zip) {
          let count = 0;
          zip.forEach(function (relativePath, zipEntry) {
            if (zipEntry.name.toLowerCase().endsWith(".xml")) {
              count++;
            }
          });
          resultadoDiv.innerHTML = `<p>Total de arquivos XML no ZIP: <span class="highlight">${count}</span></p>`;
        }).catch(function(err) {
          resultadoDiv.textContent = "Erro ao ler o arquivo ZIP: " + err;
        });
      };
      reader.readAsArrayBuffer(file);
    });

    // Excel - ler notas, valores e status
    document.getElementById('excelInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const resultadoDiv = document.getElementById('resultadoExcel');

      if (!file) {
        resultadoDiv.textContent = "Nenhum arquivo selecionado.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        let row = 3;
        let totalNotas = 0;
        let somaValores = 0;
        let canceladas = [];

        while (true) {
          const notaCell = sheet[`I${row}`];
          const valorCell = sheet[`N${row}`];
          const statusCell = sheet[`S${row}`];

          if (!notaCell || !notaCell.v) break;

          totalNotas++;

          // Soma valores
          const valor = parseFloat(valorCell?.v || 0);
          somaValores += isNaN(valor) ? 0 : valor;

          // Verifica status
          const status = statusCell?.v || "";
          if (status.includes("Cancelamento de NF-e homologado")) {
            canceladas.push(notaCell.v);
          }

          row++;
        }

        const homologadas = totalNotas - canceladas.length;
        const diferenca = homologadas - canceladas.length;

        let html = `
          <p>üìÑ Total de notas: <span class="highlight">${totalNotas}</span></p>
          <p>üí∞ Soma total dos valores: <span class="highlight">R$ ${somaValores.toFixed(2).replace('.', ',')}</span></p>
          <p class="canceladas">‚ùå Canceladas: <strong>${canceladas.length}</strong></p>
          <p class="homologadas">‚úÖ Homologadas: <strong>${homologadas}</strong></p>
          <p>üìâ Diferen√ßa (homologadas - canceladas): <strong>${diferenca}</strong></p>
        `;

        if (canceladas.length > 0) {
          html += `<ul>` + canceladas.map(n => `<li>Nota cancelada: ${n}</li>`).join('') + `</ul>`;
        }

        resultadoDiv.innerHTML = html;
      };

      reader.readAsArrayBuffer(file);
    });
  </script>

</body>
</html>
